# Техническое задание: Сервис "Каталог товаров"

## 1. Общее описание проекта

### 1.1 Назначение системы
Разработка веб-сервиса для управления каталогом товаров с возможностью гибкой конфигурации структуры справочника и характеристик товаров.

### 1.2 Цели проекта
- Создание масштабируемого каталога товаров
- Обеспечение гибкой настройки структуры данных
- Высокая производительность за счет кеширования
- Простота развертывания и сопровождения

### 1.3 Границы системы
Система включает:
- API для управления каталогом товаров
- Конфигурируемую систему характеристик
- Систему кеширования
- Административный интерфейс

## 2. Функциональные требования

### 2.1 Основные сущности

#### 2.1.1 Категории товаров
- Иерархическая структура категорий (дерево)
- Наименование и описание категории
- Статус активности
- Метаданные (дата создания, изменения)

#### 2.1.2 Товары
- Базовые атрибуты: название, описание, артикул, цена
- Связь с категорией
- Статус (активный, неактивный, архивный)
- Изображения товара
- SEO-атрибуты (meta title, description, keywords)

#### 2.1.3 Характеристики (конфигурируемые)
- Типы характеристик: строка, число, булево, список, дата
- Привязка к категориям товаров
- Обязательность заполнения
- Валидация значений
- Единицы измерения (для числовых)

#### 2.1.4 Значения характеристик
- Связь товар-характеристика-значение
- Поддержка множественных значений
- Индексирование для поиска

### 2.2 Управление категориями

#### 2.2.1 CRUD операции
- Создание, редактирование, удаление категорий
- Изменение родительской категории
- Массовые операции

#### 2.2.2 Иерархия
- Получение дерева категорий
- Поиск по пути категории
- Получение всех подкategорий

### 2.3 Управление товарами

#### 2.3.1 CRUD операции
- Создание, редактирование, удаление товаров
- Копирование товаров
- Массовое редактирование
- Импорт/экспорт товаров

#### 2.3.2 Поиск и фильтрация
- Полнотекстовый поиск
- Фильтрация по категориям
- Фильтрация по характеристикам
- Сортировка по различным полям
- Пагинация результатов

### 2.4 Управление характеристиками

#### 2.4.1 Конфигурация
- Создание новых типов характеристик
- Привязка характеристик к категориям
- Настройка валидации
- Установка значений по умолчанию

#### 2.4.2 Наследование
- Наследование характеристик от родительских категорий
- Переопределение характеристик на уровне категории

### 2.5 API Endpoints

#### 2.5.1 Категории
```
GET    /api/v1/categories              - Список категорий
GET    /api/v1/categories/tree         - Дерево категорий
GET    /api/v1/categories/{id}         - Детали категории
POST   /api/v1/categories              - Создание категории
PUT    /api/v1/categories/{id}         - Обновление категории
DELETE /api/v1/categories/{id}         - Удаление категории
```

#### 2.5.2 Товары
```
GET    /api/v1/products                - Список товаров с фильтрацией
GET    /api/v1/products/search         - Поиск товаров
GET    /api/v1/products/{id}           - Детали товара
POST   /api/v1/products                - Создание товара
PUT    /api/v1/products/{id}           - Обновление товара
DELETE /api/v1/products/{id}           - Удаление товара
POST   /api/v1/products/import         - Импорт товаров
GET    /api/v1/products/export         - Экспорт товаров
```

#### 2.5.3 Характеристики
```
GET    /api/v1/attributes              - Список характеристик
GET    /api/v1/attributes/{id}         - Детали характеристики
POST   /api/v1/attributes              - Создание характеристики
PUT    /api/v1/attributes/{id}         - Обновление характеристики
DELETE /api/v1/attributes/{id}         - Удаление характеристики
GET    /api/v1/categories/{id}/attributes - Характеристики категории
POST   /api/v1/categories/{id}/attributes - Привязка характеристик
```

## 3. Технические требования

### 3.1 Архитектура системы

#### 3.1.1 Clean Architecture
Структура проекта:
```
src/
├── domain/
│   ├── entities/
│   ├── value_objects/
│   ├── repositories/
│   └── services/
├── application/
│   ├── use_cases/
│   ├── dto/
│   └── interfaces/
├── infrastructure/
│   ├── database/
│   ├── cache/
│   ├── external/
│   └── config/
├── presentation/
│   ├── api/
│   ├── schemas/
│   └── dependencies/
└── main.py
```

#### 3.1.2 Слои архитектуры
- **Domain Layer**: Бизнес-логика, сущности, value objects
- **Application Layer**: Use cases, интерфейсы
- **Infrastructure Layer**: Реализация репозиториев, внешние сервисы
- **Presentation Layer**: API endpoints, схемы данных

### 3.2 Технологический стек

#### 3.2.1 Backend
- **Python 3.11+**
- **FastAPI** - веб-фреймворк
- **SQLAlchemy 2.0** - ORM
- **Alembic** - миграции БД
- **Pydantic** - валидация данных
- **Redis** - кеширование
- **Celery** - фоновые задачи (опционально)

#### 3.2.2 База данных
- **PostgreSQL 15+** - основная БД
- **Redis 7+** - кеш и сессии

#### 3.2.3 Инфраструктура
- **Docker & Docker Compose** - контейнеризация
- **Nginx** - прокси-сервер (опционально)
- **Prometheus + Grafana** - мониторинг (опционально)

### 3.3 Структура базы данных

#### 3.3.1 Основные таблицы
```sql
-- Категории
categories (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    parent_id UUID REFERENCES categories(id),
    path LTREE, -- для быстрого поиска по иерархии
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- Товары
products (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    sku VARCHAR(100) UNIQUE,
    price DECIMAL(10,2),
    category_id UUID REFERENCES categories(id),
    status product_status DEFAULT 'active',
    images JSONB,
    seo_data JSONB,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- Характеристики
attributes (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    type attribute_type NOT NULL,
    options JSONB, -- для списков значений
    validation_rules JSONB,
    unit VARCHAR(50),
    is_required BOOLEAN DEFAULT false,
    created_at TIMESTAMP
);

-- Привязка характеристик к категориям
category_attributes (
    id UUID PRIMARY KEY,
    category_id UUID REFERENCES categories(id),
    attribute_id UUID REFERENCES attributes(id),
    is_inherited BOOLEAN DEFAULT false,
    display_order INTEGER,
    UNIQUE(category_id, attribute_id)
);

-- Значения характеристик товаров
product_attribute_values (
    id UUID PRIMARY KEY,
    product_id UUID REFERENCES products(id),
    attribute_id UUID REFERENCES attributes(id),
    value JSONB, -- универсальное хранение
    UNIQUE(product_id, attribute_id)
);
```

#### 3.3.2 Индексы
- Полнотекстовый поиск по товарам
- GIN индексы для JSONB полей
- B-tree индексы для часто используемых полей
- Составные индексы для фильтрации

### 3.4 Кеширование

#### 3.4.1 Стратегия кеширования
- **Список категорий**: TTL 1 час
- **Дерево категорий**: TTL 30 минут
- **Детали товара**: TTL 15 минут
- **Результаты поиска**: TTL 5 минут
- **Характеристики категории**: TTL 1 час

#### 3.4.2 Инвалидация кеша
- Автоматическая при изменении данных
- Поддержка тегированного кеширования
- Массовая инвалидация по паттернам

## 4. Нефункциональные требования

### 4.1 Производительность
- Время отклика API < 100ms для простых запросов
- Время отклика поиска < 500ms
- Поддержка 1000+ одновременных пользователей
- Пагинация для всех списков

### 4.2 Масштабируемость
- Горизонтальное масштабирование через load balancer
- Поддержка read-only реплик PostgreSQL
- Кластер Redis для высокой доступности

### 4.3 Безопасность
- Валидация всех входящих данных
- SQL injection protection
- Rate limiting
- CORS настройки
- Логирование действий пользователей

### 4.4 Мониторинг и логирование
- Структурированное логирование (JSON)
- Метрики производительности
- Health check endpoints
- Error tracking

## 5. Развертывание

### 5.1 Docker Compose
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8000:8000"
    depends_on:
      - postgres
      - redis
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/catalog
      - REDIS_URL=redis://redis:6379
  
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: catalog
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### 5.2 Конфигурация
- Использование переменных окружения
- Конфигурационные файлы для разных сред
- Валидация конфигурации при запуске

## 6. Тестирование

### 6.1 Типы тестов
- Unit тесты для бизнес-логики (coverage > 80%)
- Integration тесты для API
- End-to-end тесты основных сценариев
- Performance тесты

### 6.2 Инструменты
- **pytest** - основной фреймворк
- **pytest-asyncio** - для асинхронных тестов
- **httpx** - для тестирования API
- **factory_boy** - создание тестовых данных

## 7. Документация

### 7.1 API документация
- Автоматическая генерация через FastAPI/OpenAPI
- Примеры запросов и ответов
- Описание ошибок

### 7.2 Техническая документация
- README с инструкциями по запуску
- Описание архитектуры
- Руководство по развертыванию
- Changelog

## 8. План разработки

### 8.1 Этап 1: Основа (2 недели)
- Настройка проекта и архитектуры
- База данных и модели
- Базовые CRUD операции для категорий

### 8.2 Этап 2: Товары (2 недели)
- CRUD операции для товаров
- Базовый поиск и фильтрация
- Пагинация

### 8.3 Этап 3: Характеристики (2 недели)
- Система конфигурируемых характеристик
- Привязка к категориям
- Валидация значений

### 8.4 Этап 4: Оптимизация (1 неделя)
- Кеширование
- Индексы БД
- Performance тесты

### 8.5 Этап 5: Дополнительные функции (1 неделя)
- Импорт/экспорт
- Массовые операции
- Финальное тестирование

## 9. Критерии приемки

### 9.1 Функциональные
- Все API endpoints работают согласно спецификации
- Возможность создания и изменения характеристик
- Корректная работа поиска и фильтрации
- Валидация данных работает корректно

### 9.2 Технические
- Проект разворачивается одной командой
- Тесты проходят с coverage > 80%
- API документация доступна и актуальна
- Логирование настроено и информативно

### 9.3 Производительность
- Время отклика соответствует требованиям
- Система выдерживает нагрузочные тесты
- Кеширование работает эффективно
## 10. Роли и права доступа

### 10.1 Роли пользователей
- **Администратор**: полный доступ ко всем функциям (CRUD для всех сущностей, управление характеристиками, импорт/экспорт, кеш).
- **Контент-менеджер**: доступ к товарам и категориям, без возможности изменения конфигурации характеристик.
- **Только для чтения**: доступ к просмотру данных без возможности редактирования.

### 10.2 Аутентификация и авторизация
- JWT-токены для авторизации
- OAuth2 (password flow) для получения токена
- Проверка прав доступа на уровне endpoints
- Возможность отключения авторизации для внутренних инсталляций (через конфигурацию)

## 11. Обработка исключений и edge-cases

### 11.1 Удаление категорий
- При удалении категории с подкатегориями — запрет с пояснением.
- При удалении категории с товарами — мягкое удаление или перемещение в категорию "архив".

### 11.2 Импорт товаров
- Валидация структуры файла до записи в БД
- Отчет об ошибках и успешных вставках
- Поддержка режима "dry-run"

### 11.3 Конфликты характеристик
- При наследовании конфигураций с конфликтами — логирование и запрет на сохранение до ручного разрешения

## 12. Примеры API-запросов

### 12.1 Пример запроса на создание товара
```http
POST /api/v1/products
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "Пример товара",
  "description": "Описание",
  "sku": "SKU-001",
  "price": 1999.99,
  "category_id": "uuid",
  "images": [],
  "seo_data": {
    "title": "Пример товара",
    "description": "SEO описание",
    "keywords": ["товар", "пример"]
  }
}
```

### 12.2 Ответ
```http
201 Created
Content-Type: application/json

{
  "id": "uuid",
  "name": "Пример товара",
  ...
}
```

## 13. CI/CD и разработка

### 13.1 Git Flow
- Основные ветки: `main`, `develop`, `feature/*`, `bugfix/*`, `release/*`
- Pull request с обязательным код-ревью

### 13.2 CI/CD
- Использование GitHub Actions или GitLab CI
- Сборка и прогон тестов
- Проверка code style (black, isort, flake8)
- Деплой в staging по push в `develop`, в production — по `main`

### 13.3 Code Quality
- Mypy для проверки типов
- Лимиты покрытия тестов: минимум 80% по модулям, критические use case — 100%